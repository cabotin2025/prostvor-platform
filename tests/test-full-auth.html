<!DOCTYPE html>
<html>
<head>
    <title>–ü–æ–ª–Ω—ã–π —Ç–µ—Å—Ç –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏</title>
    <style>
        body { font-family: Arial; max-width: 800px; margin: 0 auto; padding: 20px; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; border-radius: 5px; }
        .success { color: green; }
        .error { color: red; }
        pre { background: #f5f5f5; padding: 10px; overflow: auto; }
        button { margin: 5px; padding: 8px 15px; }
    </style>
</head>
<body>
    <h2>üìä –ü–æ–ª–Ω—ã–π —Ç–µ—Å—Ç —Å–∏—Å—Ç–µ–º—ã –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏</h2>
    
    <div class="section">
        <h3>1. –í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É</h3>
        <div>
            <label>Email: <input type="email" id="email" value="cabotin@mail.ru"></label>
        </div>
        <div>
            <label>–ü–∞—Ä–æ–ª—å: <input type="password" id="password" value="password"></label>
        </div>
        <button onclick="login()">–í–æ–π—Ç–∏</button>
        <div id="login-result"></div>
    </div>
    
    <div class="section">
        <h3>2. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–∞</h3>
        <button onclick="checkToken()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–æ–∫–µ–Ω</button>
        <button onclick="verifyToken()">Verify API</button>
        <div id="token-result"></div>
    </div>
    
    <div class="section">
        <h3>3. –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ</h3>
        <button onclick="showLocalStorage()">–ü–æ–∫–∞–∑–∞—Ç—å LocalStorage</button>
        <button onclick="clearStorage()">–û—á–∏—Å—Ç–∏—Ç—å Storage</button>
        <div id="storage-info"></div>
    </div>
    
    <div class="section">
        <h3>4. –û—Ç–ª–∞–¥–∫–∞</h3>
        <button onclick="testAllEndpoints()">–¢–µ—Å—Ç –≤—Å–µ—Ö endpoints</button>
        <div id="debug-info"></div>
    </div>
    
    <script>
    // 1. –§—É–Ω–∫—Ü–∏—è –≤—Ö–æ–¥–∞
    async function login() {
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        
        try {
            const response = await fetch('/api/auth/login.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, password })
            });
            
            const data = await response.json();
            const resultDiv = document.getElementById('login-result');
            
            if (data.success) {
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ
                localStorage.setItem('auth_token', data.token);
                localStorage.setItem('user_nickname', data.user.nickname);
                localStorage.setItem('user_id', data.user.actor_id);
                localStorage.setItem('user_status', data.user.global_status);
                
                resultDiv.innerHTML = `
                    <div class="success">
                        ‚úÖ –í—Ö–æ–¥ —É—Å–ø–µ—à–µ–Ω!<br>
                        –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${data.user.nickname}<br>
                        –°—Ç–∞—Ç—É—Å: ${data.user.global_status}<br>
                        –¢–æ–∫–µ–Ω (–ø–µ—Ä–≤—ã–µ 50 —Å–∏–º–≤–æ–ª–æ–≤): ${data.token.substring(0, 50)}...
                    </div>
                `;
            } else {
                resultDiv.innerHTML = `<div class="error">‚ùå ${data.message}</div>`;
            }
        } catch (error) {
            document.getElementById('login-result').innerHTML = 
                `<div class="error">‚ùå –û—à–∏–±–∫–∞: ${error.message}</div>`;
        }
    }
    
    // 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–∞
    async function checkToken() {
        const token = localStorage.getItem('auth_token');
        
        if (!token) {
            document.getElementById('token-result').innerHTML = 
                '<div class="error">‚ùå –ù–µ—Ç —Ç–æ–∫–µ–Ω–∞</div>';
            return;
        }
        
        try {
            const response = await fetch(`/api/auth/check-token.php?token=${encodeURIComponent(token)}`);
            const data = await response.json();
            
            const resultDiv = document.getElementById('token-result');
            
            if (data.authenticated) {
                resultDiv.innerHTML = `
                    <div class="success">
                        ‚úÖ –¢–æ–∫–µ–Ω –≤–∞–ª–∏–¥–µ–Ω!<br>
                        User ID: ${data.user_id}<br>
                        –ò–º—è: ${data.nickname}<br>
                        –ò—Å—Ç–µ–∫–∞–µ—Ç: ${data.expires_at}
                    </div>
                `;
            } else {
                resultDiv.innerHTML = `<div class="error">‚ùå ${data.message}</div>`;
            }
        } catch (error) {
            document.getElementById('token-result').innerHTML = 
                `<div class="error">‚ùå –û—à–∏–±–∫–∞: ${error.message}</div>`;
        }
    }
    
    // 3. Verify API
    async function verifyToken() {
        const token = localStorage.getItem('auth_token');
        
        if (!token) {
            document.getElementById('token-result').innerHTML = 
                '<div class="error">‚ùå –ù–µ—Ç —Ç–æ–∫–µ–Ω–∞</div>';
            return;
        }
        
        try {
            const response = await fetch(`/api/auth/verify.php?token=${encodeURIComponent(token)}`);
            const data = await response.json();
            
            const resultDiv = document.getElementById('token-result');
            resultDiv.innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
        } catch (error) {
            document.getElementById('token-result').innerHTML = 
                `<div class="error">‚ùå –û—à–∏–±–∫–∞: ${error.message}</div>`;
        }
    }
    
    // 4. –ü–æ–∫–∞–∑–∞—Ç—å LocalStorage
    function showLocalStorage() {
        const items = {
            'auth_token': localStorage.getItem('auth_token')?.substring(0, 50) + '...',
            'user_nickname': localStorage.getItem('user_nickname'),
            'user_id': localStorage.getItem('user_id'),
            'user_status': localStorage.getItem('user_status'),
            'user_email': localStorage.getItem('user_email')
        };
        
        document.getElementById('storage-info').innerHTML = 
            `<pre>${JSON.stringify(items, null, 2)}</pre>`;
    }
    
    // 5. –û—á–∏—Å—Ç–∏—Ç—å storage
    function clearStorage() {
        localStorage.clear();
        document.getElementById('storage-info').innerHTML = 
            '<div class="success">‚úÖ LocalStorage –æ—á–∏—â–µ–Ω</div>';
    }
    
    // 6. –¢–µ—Å—Ç –≤—Å–µ—Ö endpoints
    async function testAllEndpoints() {
    const endpoints = [
        { 
            url: '/api/auth/login.php', 
            method: 'POST',
            data: { email: 'cabotin@mail.ru', password: 'password' },
            expected: 400 // –ë–µ–∑ –¥–∞–Ω–Ω—ã—Ö - 400 Bad Request
        },
        { 
            url: '/api/auth/verify.php', 
            method: 'GET',
            expected: 401 // –ë–µ–∑ —Ç–æ–∫–µ–Ω–∞ - 401 Unauthorized
        },
        { 
            url: '/api/auth/check-token.php', 
            method: 'GET',
            expected: 200 // –í—Å–µ–≥–¥–∞ 200, –¥–∞–∂–µ –±–µ–∑ —Ç–æ–∫–µ–Ω–∞
        },
        { 
            url: '/api/test-connection.php', 
            method: 'GET',
            expected: 200 // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î
        }
    ];
    
    let results = '<h4>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∞ endpoints:</h4>';
    
    for (const endpoint of endpoints) {
        try {
            const options = {
                method: endpoint.method
            };
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–ª–æ –¥–ª—è POST –∑–∞–ø—Ä–æ—Å–æ–≤
            if (endpoint.method === 'POST' && endpoint.data) {
                options.headers = { 'Content-Type': 'application/json' };
                options.body = JSON.stringify(endpoint.data);
            }
            
            const response = await fetch(endpoint.url, options);
            const status = response.status;
            const ok = response.ok;
            
            let statusText = '';
            if (status === endpoint.expected) {
                statusText = `‚úÖ –û–∂–∏–¥–∞–µ–º—ã–π ${status}`;
            } else if (status === 200 || status === 201) {
                statusText = `‚úÖ ${status}`;
            } else if (status === 400 || status === 401 || status === 405) {
                statusText = `‚ö†Ô∏è ${status} (–Ω–æ—Ä–º–∞–ª—å–Ω–æ –¥–ª—è —ç—Ç–æ–≥–æ endpoint)`;
            } else {
                statusText = `‚ùå ${status}`;
            }
            
            results += `<div><strong>${endpoint.method} ${endpoint.url}</strong>: ${statusText}</div>`;
            
        } catch (error) {
            results += `<div><strong>${endpoint.method} ${endpoint.url}</strong>: ‚ùå ERROR ${error.message}</div>`;
        }
    }
    
    document.getElementById('debug-info').innerHTML = results;
    }
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    showLocalStorage();
    </script>
</body>
</html>